<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Inicio - Recetas</title>
    <style>
        body{font-family:Inter, Roboto, Arial, sans-serif;background:#f6f7f9;margin:0;padding:24px}
        .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
        .search{display:flex;gap:8px}
        input[type="search"]{padding:8px;border:1px solid #ddd;border-radius:6px;min-width:300px}
        button{padding:8px 12px;background:#2b7cff;color:#fff;border:0;border-radius:6px;cursor:pointer}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
        .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 16px rgba(20,30,50,0.05)}
        .title{font-weight:700;margin:0 0 6px 0}
        .controls{margin-top:16px;text-align:center}
        .empty{color:#666;text-align:center;padding:24px}
    </style>
</head>
<body>
<div class="top">
    <h1>Recetas</h1>

    <form th:action="@{ / }" method="get" class="search">
        <input type="search" name="q" th:value="${q}" placeholder="Buscar receta por nombre..." />
        <button type="submit">Buscar</button>
    </form>
</div>

<section>
    <h2 th:if="${#lists.isEmpty(resultados)}">Destacadas</h2>
    <h2 th:if="${!#lists.isEmpty(resultados)}">Resultados de búsqueda: <span th:text="${q}"></span></h2>

    <div id="grid" class="grid">
        <!-- Si hay resultados de búsqueda, mostrarlos (server-side) -->
        <div th:if="${!#lists.isEmpty(resultados)}" th:each="receta : ${resultados}">
            <div class="card">
                <p class="title" th:text="${receta.titulo}">Titulo receta</p>
                <p th:text="${#strings.substring(receta.descripcion,0,120) + (receta.descripcion.length()>120 ? '...' : '')}">Descripción corta</p>
                <a th:href="@{/recetas/{id}(id=${receta.id})}">Ver receta</a>
            </div>
        </div>

        <!-- Si no hay resultados, mostrar las 5 destacadas (server-side) -->
        <div th:if="${#lists.isEmpty(resultados)}" th:each="receta : ${destacadas}">
            <div class="card">
                <p class="title" th:text="${receta.titulo}">Titulo receta</p>
                <p th:text="${#strings.substring(receta.descripcion,0,120) + (receta.descripcion.length()>120 ? '...' : '')}">Descripción corta</p>
                <a th:href="@{/recetas/{id}(id=${receta.id})}">Ver receta</a>
            </div>
        </div>
    </div>

    <div class="controls">
        <button id="expandBtn" type="button">Mostrar hasta 100</button>
        <button id="moreBtn" type="button" style="display:none;margin-left:8px">Cargar siguientes 100</button>
    </div>

    <div class="empty" id="noMore" style="display:none">No hay más recetas.</div>
</section>

<script>
    (function(){
        const grid = document.getElementById('grid');
        const expandBtn = document.getElementById('expandBtn');
        const moreBtn = document.getElementById('moreBtn');
        const noMore = document.getElementById('noMore');

        let page = 0;
        const blockSize = 100;
        const q = new URLSearchParams(window.location.search).get('q') || '';

        function renderReplace(items) {
            grid.innerHTML = items.map(r => `
          <div class="card">
            <p class="title">\${escapeHtml(r.titulo)}</p>
            <p>\${escapeHtml((r.descripcion||'').slice(0,120))}\${(r.descripcion && r.descripcion.length>120)?'...':''}</p>
            <a href="/recetas/\${r.id}">Ver receta</a>
          </div>
        `).join('');
        }

        function renderAppend(items) {
            grid.insertAdjacentHTML('beforeend', items.map(r => `
          <div class="card">
            <p class="title">\${escapeHtml(r.titulo)}</p>
            <p>\${escapeHtml((r.descripcion||'').slice(0,120))}\${(r.descripcion && r.descripcion.length>120)?'...':''}</p>
            <a href="/recetas/\${r.id}">Ver receta</a>
          </div>
        `).join(''));
        }

        function escapeHtml(s) {
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        async function fetchPage(p, size) {
            const params = new URLSearchParams({ page: p, size: size });
            if (q) params.set('q', q);
            const res = await fetch('/api/recetas?' + params.toString());
            if (!res.ok) throw new Error('Error al cargar recetas');
            return res.json();
        }

        expandBtn.addEventListener('click', async () => {
            try {
                page = 0;
                const items = await fetchPage(page, blockSize);
                if (items.length === 0) {
                    noMore.style.display = '';
                    expandBtn.style.display = 'none';
                    moreBtn.style.display = 'none';
                    return;
                }
                renderReplace(items);
                expandBtn.style.display = 'none';
                if (items.length < blockSize) {
                    moreBtn.style.display = 'none';
                    noMore.style.display = '';
                } else {
                    moreBtn.style.display = '';
                    noMore.style.display = 'none';
                    page = 1;
                }
            } catch (e) {
                console.error(e);
            }
        });

        moreBtn.addEventListener('click', async () => {
            try {
                const items = await fetchPage(page, blockSize);
                if (items.length === 0) {
                    moreBtn.style.display = 'none';
                    noMore.style.display = '';
                    return;
                }
                renderAppend(items);
                if (items.length < blockSize) {
                    moreBtn.style.display = 'none';
                    noMore.style.display = '';
                } else {
                    page++;
                }
            } catch (e) {
                console.error(e);
            }
        });
    })();
</script>
</body>
</html>
